version: '3.8'
services:
  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    expose:
      - "8080"  # Only expose internally for NGINX to access
    depends_on:
      - nats
    environment:
      - NATS_URL=nats://nats:4222
    networks:
      - app-network

  registry-service:
    build:
      context: ./registry-service
      dockerfile: Dockerfile
    expose:
      - "8081"  # Only expose internally for NGINX to access
    depends_on:
      - nats
    environment:
      - NATS_URL=nats://nats:4222
      - SERVER_ADDRESS=:8081
      - BUCKET_NAME=functions
    networks:
      - app-network

  worker-spawner:
    build:
      context: ./worker-spawner
      dockerfile: Dockerfile
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # Accesso al Docker daemon
    expose:
      - "8082"
    depends_on:
      - nats
    environment:
      - NATS_URL=nats://nats:4222
      - MAX_CONTAINERS=5
      - FUNCTION_IMAGE=sventur/my_python_image:latest
    networks:
      - app-network

  nats:
    image: nats:latest
    expose:
      - "4222"  # Expose NATS for external and internal communication
    ports:
      - "8222:8222"  # Enable monitoring on port 8222
    command:
      - "--jetstream"
      - "--store_dir=/data/jetstream"  # Directory for JetStream data
      - "--http_port=8222"  # Enable monitoring on port 8222
    volumes:
      - ./nats-data:/data  # Persistent storage for JetStream
    networks:
      - app-network

  nginx:
    image: nginx:latest
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - auth-service
      - registry-service
    ports:
      - "4000:4000"  # External port mapped to auth-service
      - "5000:5000"  # External port mapped to registry-service
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
